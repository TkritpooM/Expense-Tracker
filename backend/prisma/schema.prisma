// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js" // ใช้ prisma-client-js เป็นมาตรฐาน
}

// -----------------------------------------------------
// 1. DATASOURCE (ต้องเชื่อมต่อกับ .env)
// -----------------------------------------------------
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL") 
}

// -----------------------------------------------------
// 2. ENUMS (การกำหนดประเภทข้อมูลจำกัด)
// -----------------------------------------------------
// ประเภทบัญชี
enum AccountType {
  Cash
  Bank
  Credit_Card @map("Credit Card")
  E_Wallet @map("E-Wallet")
  Other
}

// ประเภทหมวดหมู่
enum CategoryType {
  Income
  Expense
  Transfer
}

// ประเภทรายการธุรกรรม
enum TransactionType {
  Income
  Expense
  Transfer_Out @map("Transfer_Out")
  Transfer_In @map("Transfer_In")
}

// -----------------------------------------------------
// 3. MODELS (การกำหนดตารางฐานข้อมูล)
// -----------------------------------------------------

// ตาราง: users
model users {
  user_id       Int       @id @default(autoincrement()) @map("user_id") @db.UnsignedInt
  username      String    @unique @db.VarChar(100)
  password_hash String    @db.VarChar(255)
  email         String?   @unique @db.VarChar(100)
  created_at    DateTime? @default(now()) @db.Timestamp

  accounts      accounts[]
  categories    categories[]
  transactions  transactions[]

  @@map("users")
}

// ตาราง: accounts
model accounts {
  account_id        Int           @id @default(autoincrement()) @map("account_id") @db.UnsignedInt
  user_id           Int           @map("user_id") @db.UnsignedInt
  account_name      String        @db.VarChar(100)
  account_type      AccountType   @default(Cash)
  initial_balance   Decimal       @default(0.00) @db.Decimal(10, 2)
  current_balance   Decimal       @default(0.00) @db.Decimal(10, 2)
  is_active         Boolean       @default(true) @db.TinyInt()

  user              users         @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  transactions      transactions[] // รายการที่เป็นบัญชีต้นทาง
  transfer_in_txns  transactions[] @relation("TransferInAccount") // รายการที่เป็นบัญชีปลายทาง

  @@index([user_id], map: "fk_accounts_users_idx")
  @@map("accounts")
}

// ตาราง: categories
model categories {
  category_id   Int           @id @default(autoincrement()) @map("category_id") @db.UnsignedInt
  user_id       Int?          @map("user_id") @db.UnsignedInt
  category_name String        @db.VarChar(100)
  category_type CategoryType
  icon_name     String?       @db.VarChar(50)

  user          users?        @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
  transactions  transactions[]

  @@index([user_id], map: "fk_categories_users1_idx")
  @@map("categories")
}

// ตาราง: transactions
model transactions {
  transaction_id   Int             @id @default(autoincrement()) @map("transaction_id") @db.UnsignedInt
  user_id          Int             @map("user_id") @db.UnsignedInt
  account_id       Int             @map("account_id") @db.UnsignedInt
  category_id      Int             @map("category_id") @db.UnsignedInt
  transaction_date DateTime        @db.Date // DATE ใน MySQL
  transaction_type TransactionType
  amount           Decimal         @db.Decimal(10, 2)
  description      String?         @db.VarChar(255)
  to_account_id    Int?            @map("to_account_id") @db.UnsignedInt

  // Foreign Keys และ Constraints (onDelete)
  user             users           @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  account          accounts        @relation(fields: [account_id], references: [account_id], onDelete: Restrict)
  category         categories      @relation(fields: [category_id], references: [category_id], onDelete: Restrict)
  to_account       accounts?       @relation("TransferInAccount", fields: [to_account_id], references: [account_id], onDelete: SetNull)

  @@index([user_id], map: "fk_transactions_users1_idx")
  @@index([account_id], map: "fk_transactions_accounts1_idx")
  @@index([category_id], map: "fk_transactions_categories1_idx")
  @@index([to_account_id], map: "fk_transactions_accounts2_idx")
  @@map("transactions")
}